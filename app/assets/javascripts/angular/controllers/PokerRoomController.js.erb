//= require app.js

angular.module('ppApp').controller("PokerRoomController", [
    '$scope', '$timeout', 'PokerRoomService',

    function($scope, $timeout, PokerRoomService){

        var location = window.location.pathname.split('/');
        var id = location.pop();

        var socket, host;

        host =  "<%= ENV["WEBSOCKET_PATH"] %>" + "/" + id;
        host =  "ws://pgslnx107.pgs-soft.com:3008/" + id;

        $scope.logs  = [];
        $scope.userStory = "";


        function connect() {
            try {
                socket = new WebSocket(host);

                socket.onopen = function() {
                    addMessage("Connection Status: OPEN");
                };

                socket.onclose = function() {
                    addMessage("Connection Status: CLOSED");
                };

                socket.onmessage = function(msg) {
                    updateUserStory(msg.data);
                }
            } catch(exception) {
                addMessage("Error: " + exception);
            }


        }

        function addMessage(msg) {
            $scope.$apply(function(){
                $scope.logs.push(msg);
            });
        }

        function updateUserStory(msg){
            $scope.$apply(function () {
               $scope.userStory = msg;
            });
        }

        $scope.sendMessage = function(){

            var message = {
                type: 1,
                text: $scope.userStory,
                room: $scope.poker_room.id
            };

            message = JSON.stringify(message);

            if(message.text == '') {
                addMessage("Please Enter a Message");
                return;
            }

            try {
                socket.send(message);
            } catch(exception) {
                addMessage("Failed To Send");
            }

        };

        $scope.disconnect = function() {
          socket.close();
        };

        function init(){
            PokerRoomService.getPokerRoomAction(id);
            connect();
        }

        init();
    }
]);