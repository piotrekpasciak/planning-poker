//= require app.js

angular.module('ppApp').controller("PokerRoomController", [
    '$scope', '$rootScope', '$timeout', 'PokerRoomService',

    function($scope, $rootScope, $timeout, PokerRoomService) {

        var location = window.location.pathname.split('/');
        var id = location.pop();

        var socket, host;

        $scope.logs  = [];

        $scope.userStory = "";

        $scope.votes = [1, 2, 4, 8, 16, 32];

        function connect() {
            try {
                socket = new WebSocket(host);

                socket.onopen = function() {
                    addMessage("Connection Status: OPEN");
                };

                socket.onclose = function() {
                    addMessage("Connection Status: CLOSED");
                };

                socket.onmessage = function(msg) {
                    msg = JSON.parse(msg.data);
                    console.log(msg);
                    if(msg.type == "info") {
                        //Information about completion of connecting to websocket proccess
                    }
                    else if(msg.type == "room_status") {
                        $scope.$apply(function(){
                            $scope.onlineUsers = msg.users;
                            $scope.current_user = msg.new_name;
                        });
                        updateUserStory(msg.message);
                    }
                    else if(msg.type == "users_list") {
                        $scope.$apply(function(){
                            $scope.onlineUsers = msg.users;
                        });
                    }
                    else if(msg.type == "update_story") {
                        updateUserStory(msg.message);
                    }
                    else if(msg.type == "update_vote") {
                        updateVote(msg);
                    }
                }
            } catch(exception) {
                addMessage("Error: " + exception);
            }
        }

        function addMessage(msg) {
            $scope.$apply(function() {
                $scope.logs.push(msg);
            });
        }

        function updateUserStory(msg) {
            $scope.$apply(function () {
               $scope.userStory = msg;
            });
        }

        function updateVote(msg){
            $scope.$apply(function(){
                user = _.find($scope.onlineUsers, function(user){ return user.name == msg.name; });
                _.extend(user, {name: msg.name, vote: msg.message })
            });
        }

        $scope.sendMessage = function(type, text, room, name) {
            var message = {
                type: type,
                text: text,
                room: room,
                name: name
            };

            message = JSON.stringify(message);

            if(message.text == '') {
                addMessage("Please Enter a Message");
                return;
            }

            try {
                socket.send(message);
            } catch(exception) {
                console.log("Error occurred while connecting to websockets!")
            }
        };

        $scope.disconnect = function() {
          socket.close();
        };

        initializePokerRoomAction = function(id) {
            PokerRoomService.getPokerRoom(id).then(function(successResponse) {
                        $scope.poker_room = successResponse.data.poker_room;
                        $scope.current_user = $scope.poker_room.user_name;

                        host =  "<%= ENV["WEBSOCKET_PATH"] %>" + "/?room=" + id + "&name=" + $scope.current_user
                                + "&user_story=" + $scope.poker_room.user_story;
                        connect();
                },
                function(errorResponse) {
                    console.log("Error");
                });
        };

        function init() {
            initializePokerRoomAction(id);
        }

        init();
    }
]);