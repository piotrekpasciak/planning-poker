//= require app.js

angular.module('ppApp').controller("PokerRoomController", [
    '$scope', '$rootScope', '$timeout', 'PokerRoomService',

    function($scope, $rootScope, $timeout, PokerRoomService){

        var location = window.location.pathname.split('/');
        var id = location.pop();

        var socket, host;

        host =  "<%= ENV["WEBSOCKET_PATH"] %>" + "/" + id;
        host =  "ws://localhost:3008/" + id;

        $scope.logs  = [];

        $scope.userStory = "";


        function connect() {
            try {
                socket = new WebSocket(host);

                socket.onopen = function() {
                    addMessage("Connection Status: OPEN");
                };

                socket.onclose = function() {
                    addMessage("Connection Status: CLOSED");
                };

                socket.onmessage = function(msg) {
                    msg = JSON.parse(msg.data);
                    if(msg.type == "info"){
                        console.log(msg)
                    }
                    else if(msg.type == "update_story"){
                        updateUserStory(msg.message)
                    }
                }
            } catch(exception) {
                addMessage("Error: " + exception);
            }
        }

        function addMessage(msg) {
            $scope.$apply(function(){
                $scope.logs.push(msg);
            });
        }

        function updateUserStory(msg){
            $scope.$apply(function () {
               $scope.userStory = msg;
            });
        }

        $scope.sendMessage = function(type, text, room){

            var message = {
                type: type,
                text: text,
                room: room
            };

            message = JSON.stringify(message);

            if(message.text == '') {
                addMessage("Please Enter a Message");
                return;
            }

            try {
                socket.send(message);
            } catch(exception) {
                addMessage("Failed To Send");
            }

        };

        $scope.disconnect = function() {
          socket.close();
        };

        getPokerRoomAction = function(id){
            PokerRoomService.getPokerRoom(id).then(function(successResponse){
                        $scope.sendMessage("poker_room", successResponse.data.user_story, id);
                        $rootScope.poker_room = successResponse.data;
                    },
                    function(errorResponse){
                        console.log("Error");
                    });
        };

        function init(){
            getPokerRoomAction(id);
            connect();
        }

        init();
    }
]);